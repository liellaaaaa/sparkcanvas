# RAGçŸ¥è¯†åº“æ¨¡å—å‰ç«¯å¼€å‘æ–‡æ¡£

## ä¸€ã€æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†RAGçŸ¥è¯†åº“æ¨¡å—çš„å‰ç«¯å®žçŽ°ï¼ŒåŒ…æ‹¬æ–‡æ¡£ä¸Šä¼ ã€æ–‡æ¡£åˆ—è¡¨ã€è¯­ä¹‰æ£€ç´¢å’Œæ–‡æ¡£åˆ é™¤ç­‰åŠŸèƒ½ã€‚

## äºŒã€æ–‡ä»¶ç»“æž„

### 2.1 ä¿®æ”¹çš„æ–‡ä»¶

1. **`spark-uniapp/pages/rag/rag.vue`**
   - RAGçŸ¥è¯†åº“ä¸»é¡µé¢
   - å®žçŽ°äº†æ–‡æ¡£ä¸Šä¼ ã€åˆ—è¡¨å±•ç¤ºã€è¯­ä¹‰æ£€ç´¢ã€åˆ é™¤ç­‰åŠŸèƒ½

2. **`spark-uniapp/utils/http.js`**
   - æ·»åŠ äº†RAGç›¸å…³çš„APIè°ƒç”¨æ–¹æ³•
   - ä¿®æ­£äº†APIè·¯å¾„ä¸º `/api/v1/rag/...`

### 2.2 é¡µé¢è·¯ç”±

é¡µé¢å·²åœ¨ `pages.json` ä¸­é…ç½®ï¼š
- è·¯å¾„ï¼š`pages/rag/rag`
- æ ‡é¢˜ï¼šçŸ¥è¯†åº“
- TabBarï¼šå·²é…ç½®åœ¨åº•éƒ¨å¯¼èˆªæ 

## ä¸‰ã€åŠŸèƒ½å®žçŽ°

### 3.1 æ–‡æ¡£ä¸Šä¼ åŠŸèƒ½

**å®žçŽ°æ–¹å¼ï¼š**
- ä½¿ç”¨ `uni.chooseFile` é€‰æ‹©æ–‡ä»¶
- æ”¯æŒæ ¼å¼ï¼šPDFã€Wordã€Txt
- æ–‡ä»¶å¤§å°é™åˆ¶ï¼š50MB
- ä½¿ç”¨ `uni.uploadFile` ä¸Šä¼ æ–‡ä»¶

**ä»£ç ä½ç½®ï¼š**
```javascript
// é€‰æ‹©æ–‡ä»¶
const handleChooseFile = () => {
  uni.chooseFile({
    count: 1,
    extension: ['.pdf', '.doc', '.docx', '.txt'],
    success: (res) => {
      if (res.tempFiles && res.tempFiles.length > 0) {
        uploadDocument(res.tempFiles[0].path)
      }
    }
  })
}
```

**APIè°ƒç”¨ï¼š**
```javascript
// utils/http.js
uploadDocument: (filePath) => {
  return new Promise((resolve, reject) => {
    const token = uni.getStorageSync(config.TOKEN_KEY)
    uni.uploadFile({
      url: BASE_URL + '/api/v1/rag/upload',
      filePath: filePath,
      name: 'file',
      header: {
        'Authorization': token ? `Bearer ${token}` : ''
      },
      success: (res) => {
        const data = JSON.parse(res.data)
        if (data.code === 200) {
          resolve(data)
        } else {
          reject(new Error(data.message || 'ä¸Šä¼ å¤±è´¥'))
        }
      }
    })
  })
}
```

### 3.2 æ–‡æ¡£åˆ—è¡¨åŠŸèƒ½

**å®žçŽ°æ–¹å¼ï¼š**
- åˆ†é¡µåŠ è½½æ–‡æ¡£åˆ—è¡¨
- æ˜¾ç¤ºæ–‡æ¡£ä¿¡æ¯ï¼šæ–‡ä»¶åã€å¤§å°ã€åˆ†å—æ•°ã€ä¸Šä¼ æ—¶é—´
- æ”¯æŒåˆ†é¡µå¯¼èˆª

**ä»£ç ä½ç½®ï¼š**
```javascript
// åŠ è½½æ–‡æ¡£åˆ—è¡¨
const loadDocuments = async (resetPage = false) => {
  if (resetPage) {
    page.value = 1
  }
  
  loading.value = true
  try {
    const response = await http.getDocuments({
      page: page.value,
      page_size: pageSize.value
    })
    
    if (response.code === 200) {
      documentList.value = response.data.items || []
      total.value = response.data.total || 0
    }
  } catch (error) {
    // é”™è¯¯å¤„ç†
  } finally {
    loading.value = false
  }
}
```

**APIè°ƒç”¨ï¼š**
```javascript
// utils/http.js
getDocuments: (params) => {
  const queryString = Object.keys(params || {})
    .filter(key => params[key] !== undefined && params[key] !== null)
    .map(key => `${encodeURIComponent(key)}=${encodeURIComponent(params[key])}`)
    .join('&')
  return request({ 
    url: `/api/v1/rag/list${queryString ? '?' + queryString : ''}`, 
    method: 'GET' 
  })
}
```

### 3.3 è¯­ä¹‰æ£€ç´¢åŠŸèƒ½

**å®žçŽ°æ–¹å¼ï¼š**
- è¾“å…¥å…³é”®è¯è¿›è¡Œè¯­ä¹‰æ£€ç´¢
- æ˜¾ç¤ºæ£€ç´¢ç»“æžœå’Œç›¸ä¼¼åº¦åˆ†æ•°
- æ”¯æŒå–æ¶ˆæœç´¢è¿”å›žæ–‡æ¡£åˆ—è¡¨

**ä»£ç ä½ç½®ï¼š**
```javascript
// è¯­ä¹‰æ£€ç´¢
const handleSearch = async () => {
  if (!searchQuery.value.trim()) {
    uni.showToast({
      title: 'è¯·è¾“å…¥æœç´¢å…³é”®è¯',
      icon: 'none'
    })
    return
  }
  
  isSearchMode.value = true
  loading.value = true
  
  try {
    const response = await http.searchRAG({
      query: searchQuery.value.trim(),
      top_k: 5
    })
    
    if (response.code === 200) {
      searchResults.value = response.data.results || []
    }
  } catch (error) {
    // é”™è¯¯å¤„ç†
  } finally {
    loading.value = false
  }
}
```

**APIè°ƒç”¨ï¼š**
```javascript
// utils/http.js
searchRAG: (data) => request({ 
  url: '/api/v1/rag/search', 
  method: 'POST', 
  data 
})
```

### 3.4 æ–‡æ¡£åˆ é™¤åŠŸèƒ½

**å®žçŽ°æ–¹å¼ï¼š**
- ç‚¹å‡»åˆ é™¤æŒ‰é’®
- å¼¹å‡ºç¡®è®¤å¯¹è¯æ¡†
- åˆ é™¤æˆåŠŸåŽåˆ·æ–°åˆ—è¡¨

**ä»£ç ä½ç½®ï¼š**
```javascript
// åˆ é™¤æ–‡æ¡£
const handleDelete = (documentId, fileName) => {
  uni.showModal({
    title: 'ç¡®è®¤åˆ é™¤',
    content: `ç¡®å®šè¦åˆ é™¤æ–‡æ¡£ "${fileName}" å—ï¼Ÿ`,
    success: async (res) => {
      if (res.confirm) {
        await deleteDocument(documentId)
      }
    }
  })
}

// æ‰§è¡Œåˆ é™¤
const deleteDocument = async (documentId) => {
  try {
    const response = await http.deleteDocument(documentId)
    if (response.code === 200) {
      uni.showToast({
        title: 'åˆ é™¤æˆåŠŸ',
        icon: 'success'
      })
      loadDocuments(true)
    }
  } catch (error) {
    // é”™è¯¯å¤„ç†
  }
}
```

**APIè°ƒç”¨ï¼š**
```javascript
// utils/http.js
deleteDocument: (documentId) => {
  return request({ 
    url: `/api/v1/rag/delete?document_id=${encodeURIComponent(documentId)}`, 
    method: 'DELETE' 
  })
}
```

## å››ã€UI/UXè®¾è®¡

### 4.1 é¡µé¢å¸ƒå±€

1. **é¡¶éƒ¨æ ‡é¢˜**ï¼šðŸ“– çŸ¥è¯†åº“
2. **ä¸Šä¼ å¡ç‰‡**ï¼šä¸Šä¼ æ–‡æ¡£æŒ‰é’®å’Œæç¤º
3. **æœç´¢å¡ç‰‡**ï¼šè¯­ä¹‰æ£€ç´¢è¾“å…¥æ¡†
4. **æœç´¢ç»“æžœåŒºåŸŸ**ï¼šæ˜¾ç¤ºæ£€ç´¢ç»“æžœï¼ˆä»…åœ¨æœç´¢æ¨¡å¼ä¸‹ï¼‰
5. **æ–‡æ¡£åˆ—è¡¨åŒºåŸŸ**ï¼šæ˜¾ç¤ºæ–‡æ¡£åˆ—è¡¨ï¼ˆä»…åœ¨éžæœç´¢æ¨¡å¼ä¸‹ï¼‰
6. **åˆ†é¡µå¯¼èˆª**ï¼šåº•éƒ¨åˆ†é¡µæŽ§ä»¶

### 4.2 äº¤äº’è®¾è®¡

1. **ä¸Šä¼ æ–‡æ¡£**ï¼š
   - ç‚¹å‡»ä¸Šä¼ æŒ‰é’® â†’ é€‰æ‹©æ–‡ä»¶ â†’ è‡ªåŠ¨ä¸Šä¼  â†’ æ˜¾ç¤ºä¸Šä¼ çŠ¶æ€ â†’ åˆ·æ–°åˆ—è¡¨

2. **æ–‡æ¡£åˆ—è¡¨**ï¼š
   - æ˜¾ç¤ºæ–‡æ¡£ä¿¡æ¯ï¼ˆæ–‡ä»¶åã€å¤§å°ã€åˆ†å—æ•°ã€æ—¶é—´ï¼‰
   - ç‚¹å‡»åˆ é™¤æŒ‰é’® â†’ ç¡®è®¤å¯¹è¯æ¡† â†’ åˆ é™¤ â†’ åˆ·æ–°åˆ—è¡¨

3. **è¯­ä¹‰æ£€ç´¢**ï¼š
   - è¾“å…¥å…³é”®è¯ â†’ ç‚¹å‡»æœç´¢ â†’ æ˜¾ç¤ºç»“æžœ â†’ å¯å–æ¶ˆæœç´¢è¿”å›žåˆ—è¡¨

4. **åˆ†é¡µå¯¼èˆª**ï¼š
   - ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µæŒ‰é’®
   - æ˜¾ç¤ºå½“å‰é¡µ/æ€»é¡µæ•°/æ€»æ¡æ•°

### 4.3 çŠ¶æ€æç¤º

- **åŠ è½½çŠ¶æ€**ï¼šæ˜¾ç¤º"åŠ è½½ä¸­..."
- **ç©ºçŠ¶æ€**ï¼šæ˜¾ç¤º"æš‚æ— æ–‡æ¡£ï¼Œè¯·ä¸Šä¼ æ–‡æ¡£"
- **ä¸Šä¼ çŠ¶æ€**ï¼šæ˜¾ç¤º"ä¸Šä¼ ä¸­..."
- **æˆåŠŸæç¤º**ï¼šä½¿ç”¨ `uni.showToast` æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
- **é”™è¯¯æç¤º**ï¼šä½¿ç”¨ `uni.showToast` æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯

## äº”ã€æ•°æ®æ ¼å¼

### 5.1 æ–‡æ¡£åˆ—è¡¨å“åº”

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "total": 10,
    "page": 1,
    "page_size": 20,
    "items": [
      {
        "document_id": "uuid-string",
        "file_name": "test.pdf",
        "file_size": 1024,
        "chunks_count": 5,
        "uploaded_at": "2025-12-25T10:00:00Z"
      }
    ]
  }
}
```

### 5.2 è¯­ä¹‰æ£€ç´¢å“åº”

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "query": "æµ‹è¯•",
    "results": [
      {
        "content": "æ–‡æ¡£å†…å®¹...",
        "score": 0.9989,
        "metadata": {
          "document_id": "uuid-string",
          "file_name": "test.pdf",
          "user_id": 1,
          "chunk_index": 0
        }
      }
    ]
  }
}
```

## å…­ã€å·¥å…·å‡½æ•°

### 6.1 æ ¼å¼åŒ–æ–‡ä»¶å¤§å°

```javascript
const formatFileSize = (bytes) => {
  if (!bytes) return '0 B'
  if (bytes < 1024) return bytes + ' B'
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB'
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB'
}
```

### 6.2 æ ¼å¼åŒ–æ—¶é—´

```javascript
const formatTime = (timeStr) => {
  if (!timeStr) return ''
  const date = new Date(timeStr)
  const now = new Date()
  const diff = now - date
  
  if (diff < 60000) return 'åˆšåˆš'
  if (diff < 3600000) return `${Math.floor(diff / 60000)}åˆ†é’Ÿå‰`
  if (diff < 86400000) return `${Math.floor(diff / 3600000)}å°æ—¶å‰`
  if (diff < 604800000) return `${Math.floor(diff / 86400000)}å¤©å‰`
  
  return date.toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit'
  })
}
```

## ä¸ƒã€é”™è¯¯å¤„ç†

### 7.1 ç½‘ç»œé”™è¯¯

- ä½¿ç”¨ `try-catch` æ•èŽ·å¼‚å¸¸
- æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯æç¤º
- è®°å½•é”™è¯¯æ—¥å¿—åˆ°æŽ§åˆ¶å°

### 7.2 ä¸šåŠ¡é”™è¯¯

- æ£€æŸ¥å“åº”ä¸­çš„ `code` å­—æ®µ
- æ˜¾ç¤ºåŽç«¯è¿”å›žçš„é”™è¯¯æ¶ˆæ¯
- å¯¹äºŽ401é”™è¯¯ï¼Œè‡ªåŠ¨è·³è½¬ç™»å½•é¡µï¼ˆç”± `http.js` ç»Ÿä¸€å¤„ç†ï¼‰

### 7.3 æ–‡ä»¶ä¸Šä¼ é”™è¯¯

- æ£€æŸ¥æ–‡ä»¶å¤§å°é™åˆ¶
- æ£€æŸ¥æ–‡ä»¶æ ¼å¼
- æ˜¾ç¤ºä¸Šä¼ å¤±è´¥åŽŸå› 

## å…«ã€æµ‹è¯•è¦ç‚¹

### 8.1 åŠŸèƒ½æµ‹è¯•

1. âœ… æ–‡æ¡£ä¸Šä¼ 
   - é€‰æ‹©æ–‡ä»¶
   - ä¸Šä¼ æˆåŠŸ
   - ä¸Šä¼ å¤±è´¥å¤„ç†

2. âœ… æ–‡æ¡£åˆ—è¡¨
   - åˆ—è¡¨åŠ è½½
   - åˆ†é¡µåŠŸèƒ½
   - ç©ºçŠ¶æ€æ˜¾ç¤º

3. âœ… è¯­ä¹‰æ£€ç´¢
   - å…³é”®è¯æœç´¢
   - ç»“æžœæ˜¾ç¤º
   - å–æ¶ˆæœç´¢

4. âœ… æ–‡æ¡£åˆ é™¤
   - åˆ é™¤ç¡®è®¤
   - åˆ é™¤æˆåŠŸ
   - åˆ—è¡¨åˆ·æ–°

### 8.2 å…¼å®¹æ€§æµ‹è¯•

- H5å¹³å°
- å¾®ä¿¡å°ç¨‹åº
- Appå¹³å°ï¼ˆå¦‚éœ€è¦ï¼‰

### 8.3 æ€§èƒ½æµ‹è¯•

- å¤§æ–‡ä»¶ä¸Šä¼ 
- å¤§é‡æ–‡æ¡£åˆ—è¡¨
- æœç´¢å“åº”æ—¶é—´

## ä¹ã€æ³¨æ„äº‹é¡¹

1. **æ–‡ä»¶ä¸Šä¼ **ï¼š
   - ä½¿ç”¨ `uni.uploadFile` è€Œä¸æ˜¯ `uni.request`
   - éœ€è¦è®¾ç½®æ­£ç¡®çš„ `name` å‚æ•°ï¼ˆåŽç«¯æœŸæœ› `file`ï¼‰
   - éœ€è¦åœ¨ header ä¸­æ·»åŠ  Authorization Token

2. **APIè·¯å¾„**ï¼š
   - æ‰€æœ‰RAG APIè·¯å¾„å‰ç¼€ä¸º `/api/v1/rag/`
   - åˆ é™¤æŽ¥å£ä½¿ç”¨ Query å‚æ•°ä¼ é€’ `document_id`

3. **çŠ¶æ€ç®¡ç†**ï¼š
   - ä½¿ç”¨ Vue 3 Composition API çš„ `ref` ç®¡ç†çŠ¶æ€
   - æœç´¢æ¨¡å¼å’Œåˆ—è¡¨æ¨¡å¼ä½¿ç”¨ `isSearchMode` åˆ‡æ¢

4. **ç”¨æˆ·ä½“éªŒ**ï¼š
   - æ‰€æœ‰æ“ä½œéƒ½æœ‰åŠ è½½çŠ¶æ€æç¤º
   - åˆ é™¤æ“ä½œéœ€è¦ç¡®è®¤
   - æ“ä½œæˆåŠŸåŽæœ‰æç¤ºå¹¶è‡ªåŠ¨åˆ·æ–°

## åã€åŽç»­ä¼˜åŒ–å»ºè®®

1. **åŠŸèƒ½æ‰©å±•**ï¼š
   - æ”¯æŒæ‰¹é‡ä¸Šä¼ 
   - æ”¯æŒæ–‡æ¡£é¢„è§ˆ
   - æ”¯æŒæ–‡æ¡£é‡å‘½å

2. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - åˆ—è¡¨è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¤§é‡æ–‡æ¡£æ—¶ï¼‰
   - å›¾ç‰‡æ‡’åŠ è½½
   - æœç´¢ç»“æžœç¼“å­˜

3. **ç”¨æˆ·ä½“éªŒ**ï¼š
   - ä¸Šä¼ è¿›åº¦æ¡
   - æ‹–æ‹½ä¸Šä¼ 
   - æœç´¢åŽ†å²è®°å½•

---

**å¼€å‘å®Œæˆæ—¥æœŸï¼š** 2025-12-25  
**å¼€å‘è€…ï¼š** xc 
**çŠ¶æ€ï¼š** âœ… å·²å®Œæˆ

