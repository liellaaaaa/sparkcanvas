# RAG知识库存储路径说明

## 一、存储架构概述

RAG知识库模块采用**本地存储**方式，所有数据存储在服务器本地，**不是存储在云端**。

## 二、存储位置详解

### 2.1 上传的原始文件

**存储位置：** `spark-backend/chroma_db/temp/`

**说明：**
- 上传的文件会临时保存到这个目录
- 文件格式：`{document_id}{file_extension}`（例如：`1323af1e-7f15-44c3-ab2e-31f005df1a34.txt`）
- **重要：** 文件解析完成后会**自动删除**，不会永久保存
- 只有文档的文本内容和向量数据会被保存

**代码位置：** `spark-backend/services/rag_service.py:128-191`

```python
# 临时文件保存
temp_dir = Path(self.config.chroma_persist_directory) / "temp"
temp_file = temp_dir / f"{document_id}{file_extension}"

# ... 解析和处理 ...

# 处理完成后自动删除
finally:
    if temp_file.exists():
        temp_file.unlink()
```

### 2.2 Chroma向量数据库

**存储位置：** `spark-backend/chroma_db/`

**说明：**
- Chroma是本地向量数据库，用于存储文档的向量化数据
- 存储结构：
  ```
  chroma_db/
  ├── chroma.sqlite3          # SQLite数据库文件（元数据）
  ├── {collection_id}/        # 向量数据目录
  │   ├── data_level0.bin     # 向量数据文件
  │   ├── header.bin          # 头部信息
  │   ├── length.bin          # 长度信息
  │   └── link_lists.bin      # 链接列表
  └── temp/                   # 临时文件目录
  ```

**配置方式：**
- 默认路径：`./chroma_db`（相对于后端项目根目录）
- 可通过环境变量 `CHROMA_PERSIST_DIRECTORY` 配置
- 可在 `config/config.yaml` 中配置：
  ```yaml
  chroma:
    persist_directory: "./chroma_db"
  ```

**代码位置：** `spark-backend/storage/chroma_client.py:46-57`

### 2.3 文档元数据

**存储位置：** `spark-backend/storage/rag_metadata.json`

**说明：**
- 存储文档的基本信息（文件名、大小、分块数、上传时间等）
- JSON格式，按用户ID组织
- 结构示例：
  ```json
  {
    "1": {
      "1323af1e-7f15-44c3-ab2e-31f005df1a34": {
        "document_id": "1323af1e-7f15-44c3-ab2e-31f005df1a34",
        "file_name": "test.txt",
        "file_size": 1762,
        "chunks_count": 1,
        "uploaded_at": "2025-12-25T03:07:06.318192Z"
      }
    }
  }
  ```

**代码位置：** `spark-backend/services/rag_service.py:36-58`

## 三、Chroma持久化机制

### 3.1 持久化方式

**Chroma的持久化是永久的，不是基于时间的。**

- ✅ **永久存储**：数据一旦持久化，会一直保存在磁盘上，直到被显式删除
- ✅ **即时持久化**：每次数据变更后立即调用 `persist()` 方法写入磁盘
- ✅ **无过期时间**：数据不会自动过期或删除

### 3.2 持久化触发时机

持久化在以下操作后立即触发：

1. **上传文档后**
   ```python
   self.chroma_client.add_documents(chunks)
   self.chroma_client.persist()  # 立即持久化
   ```

2. **删除文档后**
   ```python
   self.chroma_client.delete(ids=chunk_ids_to_delete)
   self.chroma_client.persist()  # 立即持久化
   ```

### 3.3 持久化存储位置

- **SQLite数据库**：`chroma_db/chroma.sqlite3` - 存储元数据和索引
- **向量数据文件**：`chroma_db/{collection_id}/*.bin` - 存储向量数据

### 3.4 数据恢复

- 服务重启后，Chroma会自动从持久化目录加载数据
- 数据不会丢失，即使服务停止运行
- 支持增量添加和删除，无需全量重建

## 四、数据流转过程

```
用户上传文件
    ↓
临时保存到 chroma_db/temp/{document_id}.{ext}
    ↓
解析文档内容（PDF/Word/Txt）
    ↓
文本分块（RecursiveCharacterTextSplitter）
    ↓
向量化（DashScope text-embedding-v4）
    ↓
存储到 Chroma 向量数据库（chroma_db/）
    ↓
立即调用 persist() 持久化到磁盘
    ↓
保存元数据到 rag_metadata.json
    ↓
删除临时文件
```

## 五、存储特点

### 5.1 本地存储
- ✅ 所有数据存储在服务器本地
- ✅ 不需要额外的云存储服务
- ✅ 数据完全可控

### 5.2 不保存原始文件
- ✅ 只保存文本内容和向量数据
- ✅ 节省存储空间
- ✅ 保护用户隐私（原始文件在处理后立即删除）

### 5.3 持久化存储
- ✅ Chroma使用SQLite + 二进制文件持久化
- ✅ 数据不会因服务重启而丢失
- ✅ 支持增量添加和删除

## 六、配置说明

### 6.1 修改Chroma存储路径

**方式1：环境变量**
```bash
export CHROMA_PERSIST_DIRECTORY="/path/to/your/chroma_db"
```

**方式2：配置文件**
```yaml
# config/config.yaml
chroma:
  persist_directory: "/path/to/your/chroma_db"
```

**方式3：代码默认值**
```python
# core/config.py
chroma_persist_directory: str = "./chroma_db"
```

### 6.2 备份建议

如果需要备份数据，需要备份以下内容：
1. **Chroma数据库：** `spark-backend/chroma_db/` 整个目录
2. **元数据文件：** `spark-backend/storage/rag_metadata.json`

## 七、注意事项

1. **磁盘空间：** 确保服务器有足够的磁盘空间存储向量数据
2. **备份策略：** 建议定期备份 `chroma_db` 目录和 `rag_metadata.json`
3. **迁移数据：** 迁移时需要同时迁移Chroma数据库和元数据文件
4. **权限设置：** 确保后端服务有读写 `chroma_db` 目录的权限
5. **临时文件：** `temp/` 目录下的文件会在处理完成后自动删除，无需手动清理

## 八、后续优化方向

1. **云存储支持：** 可扩展支持OSS、S3等云存储服务
2. **原始文件保存：** 可配置是否保存原始文件（用于预览、下载等）
3. **元数据迁移：** 将JSON文件存储迁移到MySQL数据库
4. **分布式存储：** 支持Chroma Server模式，实现分布式存储

---

**最后更新：** 2025-12-25  
**相关文件：**
- `spark-backend/services/rag_service.py`
- `spark-backend/storage/chroma_client.py`
- `spark-backend/core/config.py`

