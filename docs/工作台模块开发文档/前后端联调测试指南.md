# å·¥ä½œå°æ¨¡å—å‰åç«¯è”è°ƒæµ‹è¯•æŒ‡å—

## ğŸ¯ æµ‹è¯•ç›®æ ‡

éªŒè¯å‰ç«¯å·¥ä½œå°é¡µé¢ä¸åç«¯å·¥ä½œå° API çš„è”è°ƒæµç¨‹æ˜¯å¦é€šç•…ï¼ŒåŒ…æ‹¬ï¼š

- ç™»å½•è·å– Token
- åˆ›å»ºä¼šè¯
- å‘é€æ¶ˆæ¯å¹¶æ”¶åˆ°å†…å®¹
- æŸ¥è¯¢ä¼šè¯ä¿¡æ¯
- ä¸Šä¼ ç´ æï¼ˆå ä½ï¼‰
- é‡æ–°ç”Ÿæˆå†…å®¹

## ğŸ“‹ å‰ç½®å‡†å¤‡

### 1. å¯åŠ¨åç«¯æœåŠ¡

```bash
cd spark-backend
python main.py
```

åç«¯æœåŠ¡é»˜è®¤è¿è¡Œåœ¨ï¼š`http://localhost:8000`

### 2. é…ç½®å‰ç«¯ API åœ°å€

åœ¨å‰ç«¯é¡¹ç›®ï¼ˆ`spark-uniapp`ï¼‰ä¸­ï¼Œç¼–è¾‘ `utils/config.js`ï¼ˆç¤ºä¾‹ï¼‰ï¼š

```javascript
const config = {
  BASE_URL: 'http://localhost:8000', // ä¸åç«¯åœ°å€ä¿æŒä¸€è‡´
  // ...
}

export default config
```

### 3. ç™»å½•è·å– Token

å‰ç«¯å¯å¤ç”¨ç™»å½•æ¨¡å—çš„é€»è¾‘ï¼š

1. ç”¨æˆ·åœ¨ç™»å½•é¡µè¾“å…¥é‚®ç®±å’Œå¯†ç 
2. è°ƒç”¨ `POST /auth/login`
3. å°†è¿”å›çš„ `token` å­˜å‚¨åœ¨æœ¬åœ°ï¼ˆä¾‹å¦‚ï¼š`storage.js` ä¸­ï¼‰

> åç»­æ‰€æœ‰å·¥ä½œå°è¯·æ±‚ï¼Œéœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦ï¼š  
> `Authorization: Bearer {token}`

### 4. æ£€æŸ¥ Redisï¼ˆå¯é€‰ï¼‰

ç”±äºå·¥ä½œå°ä¼šè¯ä¸æ¶ˆæ¯å­˜å‚¨åœ¨ Redis ä¸­ï¼Œå»ºè®®ç¡®ä¿ Redis æœåŠ¡å¯ç”¨ï¼Œ`config/config.yaml` æˆ– `.env` ä¸­ Redis URL æ­£ç¡®ã€‚

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### ç”¨ä¾‹ 1ï¼šåˆ›å»ºä¼šè¯

**å‰ç«¯æµç¨‹å»ºè®®ï¼š**

1. åœ¨å·¥ä½œå°é¡µé¢åˆå§‹åŒ–æ—¶ï¼ˆæˆ–ç‚¹å‡»ã€Œæ–°å»ºä¼šè¯ã€æŒ‰é’®æ—¶ï¼‰ï¼Œè°ƒç”¨ï¼š
   - `POST /api/v1/workspace/create-session`
2. å°†è¿”å›çš„ `session_id` å­˜å…¥å‰ç«¯çŠ¶æ€ï¼ˆå¦‚ Pinia store æˆ–æœ¬åœ°å­˜å‚¨ï¼‰

**è¯·æ±‚ç¤ºä¾‹ï¼ˆå‰ç«¯ä¼ªä»£ç ï¼‰ï¼š**

```javascript
uni.request({
  url: BASE_URL + '/api/v1/workspace/create-session',
  method: 'POST',
  header: {
    Authorization: 'Bearer ' + token
  },
  success(res) {
    const { code, data } = res.data
    if (code === 200) {
      const { session_id } = data
      // ä¿å­˜ session_id åˆ°å…¨å±€çŠ¶æ€
    }
  }
})
```

**é¢„æœŸç»“æœï¼š**

- âœ… åç«¯è¿”å› `code = 200`
- âœ… è¿”å›ä¸€ä¸ªæ–°çš„ `session_id`
- âœ… ä¼šè¯ä¿¡æ¯åœ¨ Redis ä¸­å¯è§

---

### ç”¨ä¾‹ 2ï¼šå‘é€æ¶ˆæ¯

**å‰ç«¯æµç¨‹å»ºè®®ï¼š**

1. ç”¨æˆ·åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥éœ€æ±‚æ–‡æ¡ˆ
2. ç‚¹å‡»ã€Œç”Ÿæˆå†…å®¹ã€æŒ‰é’®æ—¶ï¼š
   - è°ƒç”¨ `POST /api/v1/workspace/send-message`
   - è¯·æ±‚ä½“æºå¸¦ `session_id`ã€`message`ã€`material_source`ã€`platform`

**è¯·æ±‚ç¤ºä¾‹ï¼š**

```javascript
uni.request({
  url: BASE_URL + '/api/v1/workspace/send-message',
  method: 'POST',
  header: {
    'Content-Type': 'application/json',
    Authorization: 'Bearer ' + token
  },
  data: {
    session_id,
    message: userInput,
    material_source: 'online',      // æˆ– 'rag' / 'upload'
    platform: 'xiaohongshu'         // æˆ– 'douyin'
  },
  success(res) {
    const { code, data } = res.data
    if (code === 200) {
      // data.content.title / data.content.body / data.content.image_url
    }
  }
})
```

**é¢„æœŸç»“æœï¼š**

- âœ… æ”¶åˆ° `content.title` å’Œ `content.body`ï¼ˆå½“å‰ä¸ºå ä½æ–‡æ¡ˆï¼‰
- âœ… `status` å­—æ®µä¸º `"completed"`
- âœ… å‰ç«¯å¯å°†è¿”å›å†…å®¹å±•ç¤ºåœ¨å·¥ä½œå°ç•Œé¢

---

### ç”¨ä¾‹ 3ï¼šè·å–ä¼šè¯ä¿¡æ¯

**ç”¨é€”ï¼š**

- åœ¨å·¥ä½œå°åˆ—è¡¨é¡µæˆ–è¯¦æƒ…é¡µå±•ç¤ºä¼šè¯åŸºç¡€ä¿¡æ¯

**è¯·æ±‚ç¤ºä¾‹ï¼š**

```javascript
uni.request({
  url: BASE_URL + `/api/v1/workspace/session/${session_id}`,
  method: 'GET',
  header: {
    Authorization: 'Bearer ' + token
  },
  success(res) {
    const { code, data } = res.data
    if (code === 200) {
      // data.message_count, data.last_message_time ç­‰
    }
  }
})
```

**é¢„æœŸç»“æœï¼š**

- âœ… è¿”å› `message_count`ã€`created_at`ã€`expires_at`
- âœ… `last_message_time` éšç€å‘é€æ¶ˆæ¯æ›´æ–°

---

### ç”¨ä¾‹ 4ï¼šä¸Šä¼ ç´ æï¼ˆå ä½ï¼‰

**ç”¨é€”ï¼š**

- æœªæ¥ç”¨äº RAG / æœ¬åœ°æ–‡æ¡£ä¸Šä¼ ï¼Œç›®å‰ä»…åšå ä½ï¼Œå‰ç«¯å¯ä»¥å…ˆæ‰“é€šä¸Šä¼ é“¾è·¯ã€‚

**è¯·æ±‚ç¤ºä¾‹ï¼ˆä¼ªä»£ç ï¼‰ï¼š**

```javascript
uni.uploadFile({
  url: BASE_URL + '/api/v1/workspace/upload-material',
  filePath: localFilePath,
  name: 'file',
  formData: {
    session_id
  },
  header: {
    Authorization: 'Bearer ' + token
  },
  success(res) {
    const data = JSON.parse(res.data)
    if (data.code === 200) {
      // data.data.file_id / file_name / file_size / uploaded_at
    }
  }
})
```

**é¢„æœŸç»“æœï¼š**

- âœ… ä¸Šä¼ æˆåŠŸè¿”å›æ–‡ä»¶å…ƒä¿¡æ¯
- âœ… æš‚ä¸è¦æ±‚çœŸå®è½åœ°å­˜å‚¨ä¸è§£æ

---

### ç”¨ä¾‹ 5ï¼šé‡æ–°ç”Ÿæˆå†…å®¹

**ç”¨é€”ï¼š**

- ç”¨æˆ·å¯¹ç»“æœä¸æ»¡æ„æ—¶ï¼ŒåŸºäºåŒä¸€ä¼šè¯å‚æ•°è¿›è¡Œé‡æ–°ç”Ÿæˆã€‚

**è¯·æ±‚ç¤ºä¾‹ï¼š**

```javascript
uni.request({
  url: BASE_URL + '/api/v1/workspace/regenerate',
  method: 'POST',
  header: {
    'Content-Type': 'application/json',
    Authorization: 'Bearer ' + token
  },
  data: {
    session_id,
    adjustments: {
      emotion_intensity: 'high',
      style_preference: 'å¤§VåŒæ¬¾'
    }
  },
  success(res) {
    const { code, data } = res.data
    if (code === 200) {
      // data.content ä¸ send-message ä¿æŒä¸€è‡´ç»“æ„
    }
  }
})
```

**é¢„æœŸç»“æœï¼š**

- âœ… è¿”å›ç»“æ„ä¸ `send-message` ä¸€è‡´ï¼ˆå ä½æ–‡æ¡ˆï¼‰
- âœ… å¯ä»¥è¦†ç›–å‰ç«¯çš„å½“å‰å±•ç¤ºå†…å®¹

## ğŸ” è°ƒè¯•ä¸æ’æŸ¥

### 1. æ£€æŸ¥è¯·æ±‚å¤´

- æ˜¯å¦åŒ…å«ï¼š`Authorization: Bearer {token}`
- `Content-Type` æ˜¯å¦æ­£ç¡®ï¼ˆJSON / multipart/form-dataï¼‰

### 2. æŸ¥çœ‹è¿”å›ç»“æ„

- åç«¯ç»Ÿä¸€å“åº”ç»“æ„ï¼š

```json
{
  "code": 200,
  "message": "success",
  "data": { ... },
  "error": null
}
```

- è‹¥ `code != 200`ï¼Œå¯æŸ¥çœ‹ `message` ä¸ `error` å­—æ®µå®šä½é—®é¢˜ã€‚

### 3. å¸¸è§é”™è¯¯

1. **401 / 403 æœªæˆæƒ**
   - token ç¼ºå¤±æˆ–æ ¼å¼é”™è¯¯
   - token è¿‡æœŸ
2. **404 ä¼šè¯ä¸å­˜åœ¨**
   - `session_id` ä¸æ­£ç¡®æˆ–ä¼šè¯ TTL è¿‡æœŸ
3. **500 æœåŠ¡å™¨é”™è¯¯**
   - æ£€æŸ¥åç«¯æ—¥å¿— `spark-backend/logs/` ä¸‹çš„æ—¥å¿—æ–‡ä»¶

## âœ… è”è°ƒå®Œæˆæ ‡å‡†

1. âœ… ç™»å½•æ¨¡å— + å·¥ä½œå°æ¨¡å—æ•´æ¡é“¾è·¯æ‰“é€šï¼š
   - ç™»å½•è·å– token
   - åˆ›å»ºä¼šè¯
   - å‘é€æ¶ˆæ¯å¹¶å±•ç¤ºè¿”å›å†…å®¹
2. âœ… å‰ç«¯å°è£…å¥½ç»Ÿä¸€çš„å·¥ä½œå° API è°ƒç”¨æ–¹æ³•ï¼ˆåŸºäº `utils/http.js` æˆ–å…¶ä»–å°è£…ï¼‰
3. âœ… å¸¸è§å¼‚å¸¸åœºæ™¯æœ‰å‹å¥½æç¤ºï¼ˆæœªç™»å½•ã€ä¼šè¯å¤±æ•ˆã€ç½‘ç»œé”™è¯¯ç­‰ï¼‰

## ğŸ“ é™„ï¼šHTTP æµ‹è¯•æ–‡ä»¶

å¯ä»¥ä½¿ç”¨ `docs/å·¥ä½œå°æ¨¡å—å¼€å‘æ–‡æ¡£/test_workspace.http` æ–‡ä»¶ï¼Œåœ¨ VS Code REST Client / IDEA HTTP Client ç­‰å·¥å…·ä¸­å¿«é€Ÿå›æ”¾å·¥ä½œå°æ¥å£ï¼Œè¾…åŠ©å®šä½é—®é¢˜ã€‚ 


