# å†å²è®°å½•æ¨¡å—å¿«é€Ÿæµ‹è¯•

## ğŸš€ ä¸€é”®æµ‹è¯•ï¼ˆæ¨èï¼‰

### å‰ç½®æ¡ä»¶æ£€æŸ¥

1. **å¯åŠ¨Redis**
   ```bash
   # Windows
   redis-server
   
   # æˆ–ä½¿ç”¨Docker
   docker run -d -p 6379:6379 redis:latest
   ```

2. **å¯åŠ¨åç«¯æœåŠ¡**
   ```bash
   cd spark-backend
   python main.py
   ```

3. **å®‰è£…æµ‹è¯•ä¾èµ–**
   ```bash
   pip install requests
   ```

### è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
cd spark-backend
python test_history_api.py
```

æµ‹è¯•è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆï¼š
- âœ… å¥åº·æ£€æŸ¥
- âœ… ç™»å½•/æ³¨å†Œ
- âœ… åˆ›å»ºä¼šè¯
- âœ… å‘é€æ¶ˆæ¯ï¼ˆè‡ªåŠ¨ä¿å­˜å†å²è®°å½•ï¼‰
- âœ… æŸ¥è¯¢å†å²è®°å½•
- âœ… æœç´¢å†å²è®°å½•
- âœ… åˆ†é¡µæµ‹è¯•

## ğŸ“‹ æ‰‹åŠ¨æµ‹è¯•æ­¥éª¤

å¦‚æœè‡ªåŠ¨æµ‹è¯•è„šæœ¬é‡åˆ°é—®é¢˜ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤æ‰‹åŠ¨æµ‹è¯•ï¼š

### æ­¥éª¤1: å¯åŠ¨æœåŠ¡

```bash
# ç»ˆç«¯1: å¯åŠ¨Redis
redis-server

# ç»ˆç«¯2: å¯åŠ¨åç«¯
cd spark-backend
python main.py
```

### æ­¥éª¤2: ç™»å½•è·å–Token

```bash
curl -X POST "http://localhost:8000/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "test123456"
  }'
```

**ä¿å­˜è¿”å›çš„token**ï¼Œä¾‹å¦‚ï¼š`eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...`

### æ­¥éª¤3: åˆ›å»ºä¼šè¯

```bash
curl -X POST "http://localhost:8000/api/v1/workspace/create-session" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**ä¿å­˜è¿”å›çš„session_id**

### æ­¥éª¤4: å‘é€æ¶ˆæ¯ï¼ˆè‡ªåŠ¨ä¿å­˜å†å²è®°å½•ï¼‰

```bash
curl -X POST "http://localhost:8000/api/v1/workspace/send-message" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "session_id": "YOUR_SESSION_ID",
    "message": "å¸®æˆ‘å†™ä¸€ç¯‡å…³äºæ—…è¡Œçš„æ–‡ç« ",
    "material_source": "online",
    "platform": "xiaohongshu"
  }'
```

### æ­¥éª¤5: æŸ¥è¯¢å†å²è®°å½•

```bash
# æŸ¥è¯¢æ‰€æœ‰å†å²è®°å½•
curl "http://localhost:8000/api/v1/history/conversations?page=1&page_size=20" \
  -H "Authorization: Bearer YOUR_TOKEN"

# æŒ‰ä¼šè¯IDæŸ¥è¯¢
curl "http://localhost:8000/api/v1/history/conversations?session_id=YOUR_SESSION_ID&page=1&page_size=20" \
  -H "Authorization: Bearer YOUR_TOKEN"

# æœç´¢å†å²è®°å½•
curl "http://localhost:8000/api/v1/history/search?keyword=æ—…è¡Œ&page=1&page_size=20" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## ğŸ” éªŒè¯Rediså­˜å‚¨

```bash
# è¿æ¥Redis
redis-cli

# æŸ¥çœ‹ç”¨æˆ·ä¼šè¯ç´¢å¼•
SMEMBERS history:user:1:index

# æŸ¥çœ‹ä¼šè¯å†å²è®°å½•
LRANGE history:user:1:session:YOUR_SESSION_ID 0 -1

# æŸ¥çœ‹æœç´¢ç´¢å¼•
LRANGE history:search:user:1 0 10
```

## âš ï¸ å¸¸è§é—®é¢˜

### é—®é¢˜1: Redisè¿æ¥å¤±è´¥

**é”™è¯¯ä¿¡æ¯:** `redis_urlæœªé…ç½®ï¼Œå†å²è®°å½•å°†ä¸å¯ç”¨`

**è§£å†³æ–¹æ³•:**
1. æ£€æŸ¥RedisæœåŠ¡æ˜¯å¦å¯åŠ¨
2. åœ¨`config/config.yaml`ä¸­é…ç½®ï¼š
   ```yaml
   redis:
     url: "redis://localhost:6379/0"
   ```

### é—®é¢˜2: ç™»å½•å¤±è´¥

**é”™è¯¯ä¿¡æ¯:** `è¯¥ç”¨æˆ·ä¸å­˜åœ¨` æˆ– `é‚®ç®±æˆ–å¯†ç é”™è¯¯`

**è§£å†³æ–¹æ³•:**
1. å…ˆæ³¨å†Œç”¨æˆ·ï¼š
   ```bash
   # 1. å‘é€éªŒè¯ç 
   curl "http://localhost:8000/auth/code?email=test@example.com"
   
   # 2. ä»æ•°æ®åº“æŸ¥è¯¢éªŒè¯ç ï¼ˆæˆ–æŸ¥çœ‹é‚®ç®±ï¼‰
   # 3. æ³¨å†Œ
   curl -X POST "http://localhost:8000/auth/register" \
     -H "Content-Type: application/json" \
     -d '{
       "email": "test@example.com",
       "username": "testuser",
       "password": "test123456",
       "confirm_password": "test123456",
       "code": "ä»æ•°æ®åº“æˆ–é‚®ç®±è·å–çš„éªŒè¯ç "
     }'
   ```

### é—®é¢˜3: æŸ¥è¯¢å†å²è®°å½•ä¸ºç©º

**å¯èƒ½åŸå› :**
1. æœªå‘é€æ¶ˆæ¯ï¼ˆå†å²è®°å½•æ˜¯åœ¨å‘é€æ¶ˆæ¯æ—¶è‡ªåŠ¨ä¿å­˜çš„ï¼‰
2. ç”¨æˆ·IDä¸åŒ¹é…
3. Redisä¸­æ•°æ®å·²è¿‡æœŸï¼ˆTTL 7å¤©ï¼‰

**è§£å†³æ–¹æ³•:**
1. å…ˆå‘é€æ¶ˆæ¯
2. æ£€æŸ¥Redisä¸­æ˜¯å¦æœ‰æ•°æ®
3. ç¡®è®¤Tokenè§£æå‡ºçš„user_idæ˜¯å¦æ­£ç¡®

## ğŸ“Š é¢„æœŸæµ‹è¯•ç»“æœ

### æˆåŠŸæ ‡å¿—

1. âœ… å‘é€æ¶ˆæ¯åï¼ŒæŸ¥è¯¢å†å²è®°å½•åº”è¯¥åŒ…å«è¯¥æ¶ˆæ¯
2. âœ… æŒ‰ä¼šè¯IDæŸ¥è¯¢ï¼Œåº”è¯¥åªè¿”å›è¯¥ä¼šè¯çš„è®°å½•
3. âœ… æœç´¢å…³é”®è¯ï¼Œåº”è¯¥èƒ½æ‰¾åˆ°åŒ…å«è¯¥å…³é”®è¯çš„è®°å½•
4. âœ… Redisä¸­åº”è¯¥æœ‰å¯¹åº”çš„Keyå’Œæ•°æ®

### æµ‹è¯•æ•°æ®ç¤ºä¾‹

å‘é€æ¶ˆæ¯åï¼ŒRedisä¸­åº”è¯¥æœ‰ä»¥ä¸‹æ•°æ®ï¼š

```
Key: history:user:1:index
Type: Set
Value: [session_id1, session_id2, ...]

Key: history:user:1:session:YOUR_SESSION_ID
Type: List
Value: [
  '{"session_id":"...","message":"...","response":"...","timestamp":"..."}',
  ...
]

Key: history:search:user:1
Type: List
Value: [
  '{"session_id":"...","message":"...","response":"...","timestamp":"..."}',
  ...
]
```

## ğŸ¯ ä¸‹ä¸€æ­¥

æµ‹è¯•é€šè¿‡åï¼Œå¯ä»¥ï¼š
1. ä¸å‰ç«¯è¿›è¡Œè”è°ƒ
2. æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µä¼˜åŒ–æœç´¢ç®—æ³•
3. è§„åˆ’ä»Redisè¿ç§»åˆ°MySQLçš„æ–¹æ¡ˆ

