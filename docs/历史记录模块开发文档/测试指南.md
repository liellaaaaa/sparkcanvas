# 历史记录模块测试指南

## 一、测试前准备

### 1.1 环境检查

确保以下服务已启动：

1. **Redis服务**
   ```bash
   # Windows (如果已安装Redis)
   redis-server
   
   # 或使用Docker
   docker run -d -p 6379:6379 redis:latest
   
   # 检查Redis是否运行
   redis-cli ping
   # 应该返回: PONG
   ```

2. **MySQL服务**
   ```bash
   # 确保MySQL服务已启动
   # 检查数据库是否存在
   mysql -u root -p
   # 然后执行: SHOW DATABASES;
   ```

3. **后端服务**
   ```bash
   cd spark-backend
   python main.py
   ```
   
   服务启动后应该看到：
   ```
   INFO:     Uvicorn running on http://0.0.0.0:8000
   ```

### 1.2 配置检查

确保 `config/config.yaml` 或环境变量中已配置Redis：

```yaml
redis:
  url: "redis://localhost:6379/0"
```

## 二、测试方法

### 方法1: 使用Python测试脚本（推荐）

#### 步骤1: 安装依赖

```bash
cd spark-backend
pip install requests
```

#### 步骤2: 运行测试脚本

```bash
python test_history_api.py
```

测试脚本会自动完成以下流程：
1. ✅ 健康检查
2. ✅ 登录/注册用户
3. ✅ 创建会话
4. ✅ 发送消息（自动保存历史记录）
5. ✅ 查询所有历史记录
6. ✅ 按会话ID查询
7. ✅ 关键词搜索
8. ✅ 分页测试

### 方法2: 使用HTTP测试文件

#### 步骤1: 安装VS Code REST Client插件

在VS Code中安装 "REST Client" 插件。

#### 步骤2: 打开测试文件

打开 `docs/历史记录模块开发文档/test_history.http`

#### 步骤3: 配置Token

1. 先登录获取Token：
   ```http
   POST http://localhost:8000/api/v1/auth/login
   Content-Type: application/json
   
   {
     "email": "test@example.com",
     "password": "test123456"
   }
   ```

2. 复制返回的 `access_token`

3. 在 `test_history.http` 文件中修改：
   ```http
   @token = your_access_token_here
   ```

#### 步骤4: 执行测试

点击每个请求上方的 "Send Request" 按钮执行测试。

### 方法3: 使用curl命令

#### 步骤1: 登录获取Token

```bash
curl -X POST "http://localhost:8000/api/v1/auth/login" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "test123456"
  }'
```

保存返回的 `access_token`。

#### 步骤2: 创建会话并发送消息

```bash
# 创建会话
SESSION_ID=$(curl -X POST "http://localhost:8000/api/v1/workspace/create-session" \
  -H "Authorization: Bearer YOUR_TOKEN" | jq -r '.data.session_id')

# 发送消息
curl -X POST "http://localhost:8000/api/v1/workspace/send-message" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d "{
    \"session_id\": \"$SESSION_ID\",
    \"message\": \"帮我写一篇关于旅行的文章\",
    \"material_source\": \"online\",
    \"platform\": \"xiaohongshu\"
  }"
```

#### 步骤3: 查询历史记录

```bash
# 查询所有历史记录
curl "http://localhost:8000/api/v1/history/conversations?page=1&page_size=20" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 按会话ID查询
curl "http://localhost:8000/api/v1/history/conversations?session_id=YOUR_SESSION_ID&page=1&page_size=20" \
  -H "Authorization: Bearer YOUR_TOKEN"

# 搜索历史记录
curl "http://localhost:8000/api/v1/history/search?keyword=旅行&page=1&page_size=20" \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 方法4: 使用Swagger UI（可视化测试）

#### 步骤1: 访问Swagger UI

打开浏览器访问：`http://localhost:8000/docs`

#### 步骤2: 认证

1. 点击右上角的 "Authorize" 按钮
2. 在弹出框中输入：`Bearer YOUR_TOKEN`
3. 点击 "Authorize" 确认

#### 步骤3: 测试接口

1. 找到 "历史记录" 分组
2. 展开接口，点击 "Try it out"
3. 填写参数，点击 "Execute"
4. 查看响应结果

## 三、测试用例

### 3.1 基础功能测试

| 测试项 | 接口 | 预期结果 |
|--------|------|----------|
| 查询所有历史记录 | `GET /api/v1/history/conversations` | 返回分页的历史记录列表 |
| 按会话ID查询 | `GET /api/v1/history/conversations?session_id=xxx` | 返回指定会话的历史记录 |
| 关键词搜索 | `GET /api/v1/history/search?keyword=xxx` | 返回匹配的记录 |
| 分页功能 | `GET /api/v1/history/conversations?page=1&page_size=10` | 正确分页返回 |

### 3.2 边界测试

| 测试项 | 参数 | 预期结果 |
|--------|------|----------|
| 空历史记录 | 新用户，未发送消息 | 返回空列表，total=0 |
| 最大分页 | `page_size=100` | 返回最多100条记录 |
| 超出最大分页 | `page_size=101` | 返回400错误 |
| 空关键词搜索 | `keyword=""` | 返回400错误 |
| 未授权访问 | 不带Token | 返回401错误 |

### 3.3 数据一致性测试

1. **发送消息后立即查询**
   - 发送消息 → 立即查询历史记录
   - 预期：新消息应该出现在历史记录中

2. **多会话数据隔离**
   - 创建两个会话，分别发送消息
   - 按会话ID查询，应该只返回对应会话的记录

3. **搜索准确性**
   - 发送包含特定关键词的消息
   - 使用该关键词搜索，应该能找到对应记录

## 四、验证Redis存储

### 4.1 使用Redis CLI验证

```bash
# 连接Redis
redis-cli

# 查看用户会话索引
SMEMBERS history:user:1:index

# 查看会话历史记录（替换user_id和session_id）
LRANGE history:user:1:session:YOUR_SESSION_ID 0 -1

# 查看搜索索引
LRANGE history:search:user:1 0 10

# 查看Key的TTL
TTL history:user:1:session:YOUR_SESSION_ID
```

### 4.2 验证数据格式

Redis中存储的数据应该是JSON格式，例如：

```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "message": "帮我写一篇关于旅行的文章",
  "response": "标题\n\n正文内容...",
  "timestamp": "2026-01-01T10:00:00Z"
}
```

## 五、常见问题排查

### 5.1 后端服务无法启动

**问题:** `python main.py` 报错

**排查步骤:**
1. 检查Python版本（需要3.8+）
2. 检查依赖是否安装：`pip install -r requirements.txt`
3. 检查配置文件是否正确
4. 查看错误日志

### 5.2 Redis连接失败

**问题:** 历史记录保存失败，日志显示Redis连接错误

**排查步骤:**
1. 检查Redis服务是否启动：`redis-cli ping`
2. 检查Redis URL配置是否正确
3. 检查Redis是否设置了密码（如果设置了，需要在URL中包含密码）

### 5.3 查询返回空数据

**问题:** 发送消息后查询历史记录为空

**排查步骤:**
1. 检查Redis中是否有数据：`redis-cli KEYS "history:*"`
2. 检查用户ID是否正确（Token解析出的user_id）
3. 检查历史记录保存是否成功（查看后端日志）

### 5.4 搜索功能不工作

**问题:** 搜索关键词找不到记录

**排查步骤:**
1. 确认已发送过消息
2. 检查搜索索引是否存在：`redis-cli LRANGE history:search:user:1 0 10`
3. 确认关键词在消息或回复中存在
4. 检查搜索逻辑（当前是简单的字符串匹配）

### 5.5 认证失败

**问题:** 返回401未授权错误

**排查步骤:**
1. 检查Token是否正确
2. 检查Token是否过期（默认2小时）
3. 检查请求头格式：`Authorization: Bearer YOUR_TOKEN`
4. 重新登录获取新Token

## 六、性能测试建议

### 6.1 批量数据测试

```python
# 可以修改测试脚本，批量发送消息
for i in range(100):
    tester.send_message(f"测试消息 {i}")
```

### 6.2 监控指标

- Redis内存使用量
- 查询响应时间
- 搜索响应时间
- 并发请求处理能力

## 七、测试检查清单

- [ ] Redis服务已启动
- [ ] 后端服务已启动
- [ ] 已登录获取Token
- [ ] 已创建会话
- [ ] 已发送至少一条消息
- [ ] 查询所有历史记录成功
- [ ] 按会话ID查询成功
- [ ] 关键词搜索成功
- [ ] 分页功能正常
- [ ] Redis中数据格式正确
- [ ] TTL设置正确（7天）

## 八、测试报告模板

测试完成后，可以记录以下信息：

```
测试日期: YYYY-MM-DD
测试人员: XXX
后端版本: v1.0.0

测试结果:
- 基础功能: ✅/❌
- 边界测试: ✅/❌
- 数据一致性: ✅/❌
- 性能测试: ✅/❌

发现问题:
1. ...
2. ...

建议:
1. ...
2. ...
```

