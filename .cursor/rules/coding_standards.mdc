# 编码规范

## 规则目的

本规则文件定义了SparkCanvas项目的Python编码规范和代码风格要求，确保代码的一致性和可读性。

## 适用范围

- 所有Python代码文件
- 代码审查标准
- 代码格式化要求

## Python代码风格

### 1. PEP 8规范

遵循PEP 8 Python编码规范：

- **缩进**：使用4个空格，不使用Tab
- **行长度**：每行不超过100字符（可适当放宽到120）
- **空行**：函数和类之间使用2个空行，方法之间使用1个空行
- **导入顺序**：
  1. 标准库导入
  2. 第三方库导入
  3. 项目内部导入

**示例：**
```python
# 标准库
import asyncio
from datetime import datetime
from typing import Optional, List

# 第三方库
from fastapi import APIRouter, Depends, HTTPException
from sqlalchemy.orm import Mapped, mapped_column

# 项目内部
from models import Base
from schemas.prompt import PromptCreateIn
from utils.response import APIResponse
```

### 2. 命名规范

**类名：** PascalCase（大驼峰）
```python
class PromptService:
    pass

class PromptRepository:
    pass
```

**函数/方法名：** snake_case（小写下划线）
```python
async def create_prompt():
    pass

async def get_by_id():
    pass
```

**常量：** UPPER_SNAKE_CASE（大写下划线）
```python
MAX_PAGE_SIZE = 100
DEFAULT_PAGE = 1
```

**变量名：** snake_case（小写下划线）
```python
user_id = 1
prompt_name = "模板名称"
```

**私有方法/属性：** 单下划线前缀
```python
def _validate_data(self):
    pass

def _internal_method(self):
    pass
```

### 3. 类型注解

**必须使用类型注解：**
- 函数参数
- 返回值
- 类属性
- 变量（复杂类型）

**示例：**
```python
from typing import Optional, List

async def create_prompt(
    user_id: int,
    data: PromptCreateIn,
) -> APIResponse:
    """创建Prompt"""
    pass

class PromptService:
    def __init__(self, repo: PromptRepository) -> None:
        self.repo: PromptRepository = repo
    
    async def list_prompts(
        self,
        user_id: int,
        page: int = 1,
        page_size: int = 20,
    ) -> List[Prompt]:
        pass
```

**使用Union和Optional：**
```python
from typing import Optional, Union

async def get_prompt(id: int) -> Optional[Prompt]:
    """可能返回None"""
    pass

def process_data(data: Union[str, int]) -> str:
    """接受多种类型"""
    pass
```

**使用类型别名：**
```python
from typing import List, Dict, Any

PromptList = List[Prompt]
ResponseData = Dict[str, Any]
```

### 4. 文档字符串（Docstring）

**所有公共类、函数、方法必须包含docstring：**

```python
class PromptService:
    """Prompt管理服务
    
    负责Prompt的创建、查询、更新、删除等业务逻辑。
    """
    
    async def create_prompt(
        self,
        user_id: int,
        data: PromptCreateIn,
    ) -> APIResponse:
        """创建Prompt模板
        
        Args:
            user_id: 用户ID
            data: Prompt创建数据
            
        Returns:
            APIResponse: 包含创建的Prompt信息
            
        Raises:
            HTTPException: 当数据验证失败或创建失败时抛出
        """
        pass
```

**Docstring格式：**
- 使用中文描述
- 包含功能说明
- 参数说明（Args）
- 返回值说明（Returns）
- 异常说明（Raises）

### 5. 注释规范

**行内注释：**
```python
# 验证用户权限
if prompt.user_id != user_id:
    raise HTTPException(status_code=403, detail="无权限")

# 计算分页偏移量
offset = (page - 1) * page_size
```

**块注释：**
```python
# 以下代码处理Prompt创建逻辑：
# 1. 验证输入数据
# 2. 检查权限
# 3. 创建Prompt记录
# 4. 返回结果
```

**TODO注释：**
```python
# TODO: 添加模板变量替换功能
# FIXME: 修复分页查询的性能问题
# NOTE: 此方法需要优化，当前实现较慢
```

## 异步编程规范

### 1. 异步函数定义

**所有涉及I/O操作的函数必须使用async/await：**

```python
# ✅ 正确
async def get_prompt(id: int) -> Optional[Prompt]:
    async with self.session.begin():
        return await self.session.get(Prompt, id)

# ❌ 错误
def get_prompt(id: int) -> Optional[Prompt]:
    return self.session.get(Prompt, id)  # 同步操作
```

### 2. 异步上下文管理器

**数据库操作必须使用异步上下文管理器：**

```python
async def create_prompt(self, user_id: int, data: PromptCreateIn) -> Prompt:
    async with self.session.begin():
        prompt = Prompt(user_id=user_id, **data.model_dump())
        self.session.add(prompt)
        return prompt
```

### 3. 并发处理

**使用asyncio.gather进行并发操作：**

```python
import asyncio

async def batch_create_prompts(prompts: List[PromptCreateIn]) -> List[Prompt]:
    tasks = [self.create_prompt(p) for p in prompts]
    return await asyncio.gather(*tasks)
```

## 错误处理规范

### 1. 异常类型

**使用具体的异常类型：**

```python
from fastapi import HTTPException
from sqlalchemy.exc import SQLAlchemyError

# ✅ 正确
if not prompt:
    raise HTTPException(status_code=404, detail="Prompt不存在")

# ❌ 错误
if not prompt:
    raise Exception("Prompt不存在")
```

### 2. 异常处理

**捕获具体异常，避免裸except：**

```python
# ✅ 正确
try:
    result = await self.repo.create(data)
except SQLAlchemyError as e:
    logger.error(f"数据库错误: {e}")
    raise HTTPException(status_code=500, detail="创建失败")

# ❌ 错误
try:
    result = await self.repo.create(data)
except:  # 捕获所有异常
    pass
```

### 3. 异常信息

**提供清晰的错误信息：**

```python
# ✅ 正确
raise HTTPException(
    status_code=400,
    detail="name和content不能为空"
)

# ❌ 错误
raise HTTPException(status_code=400, detail="错误")
```

## 代码组织规范

### 1. 导入顺序

```python
# 1. 标准库
import asyncio
from datetime import datetime
from typing import Optional, List

# 2. 第三方库
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Mapped

# 3. 项目内部（按模块分组）
from models import Base
from models.prompt import Prompt
from schemas.prompt import PromptCreateIn
from services.prompt_service import PromptService
from utils.response import APIResponse
```

### 2. 类组织

```python
class PromptService:
    """类文档字符串"""
    
    # 类变量
    MAX_PAGE_SIZE = 100
    
    def __init__(self, repo: PromptRepository):
        """初始化方法"""
        self.repo = repo
    
    # 公共方法
    async def create_prompt(self, ...):
        """公共方法"""
        pass
    
    # 私有方法
    def _validate_data(self, ...):
        """私有方法"""
        pass
```

### 3. 函数长度

**函数不应过长，建议不超过50行：**

```python
# ✅ 好的设计：将复杂逻辑拆分为多个函数
async def create_prompt(self, user_id: int, data: PromptCreateIn) -> APIResponse:
    """创建Prompt"""
    self._validate_create_data(data)
    self._check_permission(user_id)
    prompt = await self._create_prompt_record(user_id, data)
    return self._build_response(prompt)

# ❌ 不好的设计：所有逻辑在一个函数中
async def create_prompt(self, user_id: int, data: PromptCreateIn) -> APIResponse:
    # 100+ 行代码...
    pass
```

## 代码质量要求

### 1. 可读性

- 使用有意义的变量名
- 避免魔法数字和字符串
- 保持函数简洁
- 添加必要的注释

### 2. 可维护性

- 遵循单一职责原则
- 避免代码重复（DRY原则）
- 使用配置而非硬编码
- 保持函数和类的规模适中

### 3. 性能

- 避免不必要的数据库查询
- 使用索引优化查询
- 合理使用缓存
- 避免N+1查询问题

### 4. 安全性

- 验证所有用户输入
- 使用参数化查询防止SQL注入
- 校验用户权限
- 不暴露敏感信息

## 代码审查检查清单

- [ ] 遵循PEP 8规范
- [ ] 使用类型注解
- [ ] 包含docstring
- [ ] 错误处理完善
- [ ] 没有硬编码值
- [ ] 代码可读性良好
- [ ] 没有代码重复
- [ ] 性能考虑合理
- [ ] 安全性检查通过
- [ ] 单元测试覆盖

## 工具推荐

### 代码格式化

- **black**: 自动格式化代码
- **isort**: 自动整理导入顺序

### 代码检查

- **pylint**: 代码质量检查
- **mypy**: 类型检查
- **flake8**: PEP 8规范检查

### 配置示例

**pyproject.toml:**
```toml
[tool.black]
line-length = 100
target-version = ['py311']

[tool.isort]
profile = "black"
line_length = 100

[tool.mypy]
python_version = "3.11"
warn_return_any = true
warn_unused_configs = true
```
