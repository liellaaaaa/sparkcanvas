# 数据库操作规范

## 规则目的

本规则文件定义了SparkCanvas项目的数据库操作规范，确保数据访问的一致性、安全性和性能。

## 适用范围

- 所有数据库操作
- ORM模型定义
- Repository层实现
- 数据库迁移

## SQLAlchemy使用规范

### 1. 模型定义

**使用SQLAlchemy 2.0语法：**

```python
from models import Base
from sqlalchemy.orm import mapped_column, Mapped
from sqlalchemy import Integer, String, Text, DateTime, ForeignKey
from datetime import datetime

class Prompt(Base):
    """Prompt模板模型"""
    __tablename__ = 'prompt'
    
    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    name: Mapped[str] = mapped_column(String(255), nullable=False)
    content: Mapped[str] = mapped_column(Text, nullable=False)
    user_id: Mapped[int] = mapped_column(
        Integer,
        ForeignKey("user.id"),
        nullable=False,
        index=True
    )
    created_at: Mapped[datetime] = mapped_column(
        DateTime,
        default=datetime.now,
        nullable=False
    )
    updated_at: Mapped[datetime] = mapped_column(
        DateTime,
        default=datetime.now,
        onupdate=datetime.now,
        nullable=False
    )
```

### 2. 字段类型

**常用字段类型：**

```python
# 字符串
name: Mapped[str] = mapped_column(String(255))
description: Mapped[str | None] = mapped_column(String(500), nullable=True)

# 文本
content: Mapped[str] = mapped_column(Text)

# 整数
id: Mapped[int] = mapped_column(Integer, primary_key=True)
user_id: Mapped[int] = mapped_column(Integer, ForeignKey("user.id"))

# 布尔值
is_active: Mapped[bool] = mapped_column(Boolean, default=True)

# 日期时间
created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.now)
```

### 3. 关系定义

**外键关系：**

```python
user_id: Mapped[int] = mapped_column(
    Integer,
    ForeignKey("user.id", ondelete="CASCADE"),
    nullable=False
)
```

**一对多关系：**

```python
from sqlalchemy.orm import relationship

class User(Base):
    prompts: Mapped[List["Prompt"]] = relationship("Prompt", back_populates="user")

class Prompt(Base):
    user: Mapped["User"] = relationship("User", back_populates="prompts")
```

## 异步操作规范

### 1. 异步会话

**所有数据库操作使用异步会话：**

```python
from sqlalchemy.ext.asyncio import AsyncSession

class PromptRepository:
    def __init__(self, session: AsyncSession):
        self.session = session
```

### 2. 事务管理

**使用上下文管理器管理事务：**

```python
async def create(self, user_id: int, data: PromptCreateIn) -> Prompt:
    async with self.session.begin():
        prompt = Prompt(user_id=user_id, **data.model_dump())
        self.session.add(prompt)
        await self.session.flush()  # 获取生成的ID
        return prompt
```

### 3. 查询操作

**使用异步查询方法：**

```python
from sqlalchemy import select

async def get_by_id(self, prompt_id: int, user_id: int) -> Prompt | None:
    async with self.session.begin():
        stmt = select(Prompt).where(
            Prompt.id == prompt_id,
            Prompt.user_id == user_id
        )
        result = await self.session.scalar(stmt)
        return result
```

## Repository层规范

### 1. 基本CRUD操作

**创建（Create）：**

```python
async def create(self, user_id: int, data: PromptCreateIn) -> Prompt:
    """创建Prompt"""
    async with self.session.begin():
        prompt = Prompt(user_id=user_id, **data.model_dump())
        self.session.add(prompt)
        await self.session.flush()
        return prompt
```

**读取（Read）：**

```python
async def get_by_id(self, prompt_id: int, user_id: int) -> Prompt | None:
    """根据ID获取Prompt"""
    async with self.session.begin():
        stmt = select(Prompt).where(
            Prompt.id == prompt_id,
            Prompt.user_id == user_id
        )
        return await self.session.scalar(stmt)

async def get_by_user_id(
    self,
    user_id: int,
    page: int = 1,
    page_size: int = 20,
    platform: Optional[str] = None,
    category: Optional[str] = None,
) -> tuple[List[Prompt], int]:
    """分页查询用户的Prompt列表"""
    async with self.session.begin():
        # 构建查询
        stmt = select(Prompt).where(Prompt.user_id == user_id)
        
        # 筛选条件
        if platform:
            stmt = stmt.where(Prompt.platform == platform)
        if category:
            stmt = stmt.where(Prompt.category == category)
        
        # 总数查询
        count_stmt = select(func.count()).select_from(stmt.subquery())
        total = await self.session.scalar(count_stmt)
        
        # 分页查询
        offset = (page - 1) * page_size
        stmt = stmt.offset(offset).limit(page_size).order_by(Prompt.created_at.desc())
        items = (await self.session.scalars(stmt)).all()
        
        return list(items), total
```

**更新（Update）：**

```python
async def update(
    self,
    prompt_id: int,
    user_id: int,
    data: PromptUpdateIn,
) -> Prompt:
    """更新Prompt"""
    async with self.session.begin():
        stmt = select(Prompt).where(
            Prompt.id == prompt_id,
            Prompt.user_id == user_id
        )
        prompt = await self.session.scalar(stmt)
        
        if not prompt:
            return None
        
        # 更新字段
        update_data = data.model_dump(exclude_unset=True)
        for key, value in update_data.items():
            setattr(prompt, key, value)
        
        await self.session.flush()
        return prompt
```

**删除（Delete）：**

```python
async def delete(self, prompt_id: int, user_id: int) -> bool:
    """删除Prompt"""
    async with self.session.begin():
        stmt = select(Prompt).where(
            Prompt.id == prompt_id,
            Prompt.user_id == user_id
        )
        prompt = await self.session.scalar(stmt)
        
        if not prompt:
            return False
        
        await self.session.delete(prompt)
        return True
```

### 2. 权限校验方法

```python
async def check_ownership(self, prompt_id: int, user_id: int) -> bool:
    """检查Prompt是否属于指定用户"""
    async with self.session.begin():
        stmt = select(Prompt).where(
            Prompt.id == prompt_id,
            Prompt.user_id == user_id
        )
        result = await self.session.scalar(stmt)
        return result is not None
```

## 查询优化

### 1. 索引使用

**为常用查询字段添加索引：**

```python
user_id: Mapped[int] = mapped_column(
    Integer,
    ForeignKey("user.id"),
    nullable=False,
    index=True  # 添加索引
)

platform: Mapped[str] = mapped_column(
    String(50),
    default="通用",
    nullable=False,
    index=True  # 添加索引
)
```

### 2. 避免N+1查询

**使用join预加载关联数据：**

```python
from sqlalchemy.orm import selectinload

stmt = select(Prompt).options(
    selectinload(Prompt.user)
).where(Prompt.id == prompt_id)
```

### 3. 分页查询

**使用offset和limit：**

```python
offset = (page - 1) * page_size
stmt = stmt.offset(offset).limit(page_size)
```

### 4. 排序

**使用order_by：**

```python
stmt = stmt.order_by(Prompt.created_at.desc())
```

## 错误处理

### 1. 数据库异常

**捕获并转换数据库异常：**

```python
from sqlalchemy.exc import SQLAlchemyError
from core.logger import logger

async def create(self, user_id: int, data: PromptCreateIn) -> Prompt:
    try:
        async with self.session.begin():
            prompt = Prompt(user_id=user_id, **data.model_dump())
            self.session.add(prompt)
            await self.session.flush()
            return prompt
    except SQLAlchemyError as e:
        logger.error(f"数据库错误: {e}")
        raise  # 向上抛出，由Service层处理
```

### 2. 数据不存在

**返回None而不是抛出异常：**

```python
async def get_by_id(self, prompt_id: int, user_id: int) -> Prompt | None:
    """返回None表示不存在，不抛异常"""
    async with self.session.begin():
        stmt = select(Prompt).where(
            Prompt.id == prompt_id,
            Prompt.user_id == user_id
        )
        return await self.session.scalar(stmt)
```

## 数据库迁移

### 1. 初始化数据库

**使用init_db.py初始化表结构：**

```python
# init_db.py
from models import Base
from models.prompt import Prompt

async def init_database():
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
```

### 2. 模型导入

**在models/__init__.py中导入所有模型：**

```python
# models/__init__.py
from .user import User, EmailCode
from .prompt import Prompt  # 导入Prompt模型
```

## 最佳实践

### 1. 数据隔离

**所有查询必须包含user_id条件：**

```python
# ✅ 正确
stmt = select(Prompt).where(
    Prompt.id == prompt_id,
    Prompt.user_id == user_id  # 必须包含
)

# ❌ 错误
stmt = select(Prompt).where(Prompt.id == prompt_id)
```

### 2. 事务边界

**在Repository层管理事务：**

```python
# ✅ 正确
async def create(self, ...):
    async with self.session.begin():
        # 数据库操作
        pass

# ❌ 错误：在Service层管理事务
```

### 3. 查询性能

**使用索引优化查询：**
- 为外键字段添加索引
- 为常用筛选字段添加索引
- 为排序字段添加索引

### 4. 数据一致性

**使用外键约束：**

```python
user_id: Mapped[int] = mapped_column(
    Integer,
    ForeignKey("user.id", ondelete="CASCADE"),
    nullable=False
)
```

## 常见问题

### 1. 会话管理

**问题：** 忘记关闭会话

**解决：** 使用上下文管理器自动管理

```python
async with self.session.begin():
    # 操作完成后自动提交或回滚
    pass
```

### 2. 事务嵌套

**问题：** 嵌套事务导致问题

**解决：** 避免在Repository方法中嵌套事务

### 3. 查询性能

**问题：** 查询慢

**解决：**
- 添加索引
- 使用join代替多次查询
- 使用分页限制结果集大小
