# Prompt模块开发规则

## 规则目的

本规则文件定义了Prompt模块的开发规范，确保代码质量、架构一致性和可维护性。

## 适用范围

- Prompt模块的所有代码文件
- `models/prompt.py` - 数据模型
- `schemas/prompt.py` - Schema定义
- `repository/prompt_repo.py` - 数据访问层
- `services/prompt_service.py` - 业务服务层
- `routers/prompt.py` - 路由层

## 核心规范

### 1. 架构分层

严格遵循分层架构，各层职责明确：

```
routers/ → services/ → repository/ → models/
```

**各层职责：**
- **routers层**：HTTP请求/响应处理，参数校验，调用service
- **services层**：业务逻辑处理，权限校验，错误处理
- **repository层**：数据库CRUD操作，查询构建
- **models层**：数据模型定义，ORM映射

**禁止行为：**
- ❌ 路由层直接调用repository
- ❌ Service层直接操作数据库会话
- ❌ 跨层调用（如repository调用service）

### 2. Prompt模型规范

**必填字段：**
- `name`: 模板名称，String(255)，不能为空
- `content`: Prompt内容，Text类型，不能为空
- `user_id`: 用户ID，Integer，外键关联User表

**可选字段：**
- `platform`: 平台类型，String(50)，默认"通用"，可选值："xiaohongshu"、"douyin"、"通用"
- `category`: 分类/垂类，String(100)，可为空
- `description`: 模板描述，String(500)，可为空

**时间字段：**
- `created_at`: 创建时间，自动设置
- `updated_at`: 更新时间，自动更新

### 3. Schema定义规范

**请求Schema：**
- `PromptCreateIn`: 创建请求，必填name和content
- `PromptUpdateIn`: 更新请求，必填id，其他字段可选
- `PromptDeleteIn`: 删除请求，必填id

**响应Schema：**
- `PromptOut`: 单个Prompt输出，包含所有字段
- `PromptListOut`: 分页列表输出，包含total、page、page_size、items

**查询参数Schema：**
- `PromptListQuery`: 支持platform、category筛选，支持分页

**验证规则：**
- 使用`Field(..., description="...")`定义必填字段
- 使用`Optional[...]`或默认值定义可选字段
- 使用`Literal`限制platform可选值
- 字符串长度限制：name≤255，description≤500

### 4. Repository层规范

**方法命名：**
- `create()`: 创建Prompt
- `get_by_id()`: 根据ID获取（包含user_id校验）
- `get_by_user_id()`: 根据用户ID分页查询（支持筛选）
- `update()`: 更新Prompt
- `delete()`: 删除Prompt
- `check_ownership()`: 检查所有权

**查询规范：**
- 所有查询必须包含`user_id`条件（确保数据隔离）
- 使用`async with self.session.begin()`管理事务
- 分页查询使用`offset`和`limit`
- 筛选条件使用`where`子句动态构建

**错误处理：**
- 查询不存在返回`None`，不抛异常
- 数据库异常向上抛出，由service层处理

### 5. Service层规范

**方法职责：**
- `create_prompt()`: 创建Prompt，验证数据，调用repository
- `list_prompts()`: 查询列表，处理分页和筛选
- `update_prompt()`: 更新Prompt，校验所有权
- `delete_prompt()`: 删除Prompt，校验所有权
- `get_prompt_by_id()`: 获取详情，校验所有权

**权限校验：**
- 所有操作必须校验`user_id`
- 更新/删除操作必须调用`check_ownership()`
- 权限错误抛出`HTTPException(status_code=403)`
- 资源不存在抛出`HTTPException(status_code=404)`

**响应格式：**
- 成功返回`APIResponse(code=200, message="success", data=...)`
- 错误使用`HTTPException`或`error_response()`

### 6. Router层规范

**路由配置：**
- 前缀：`/api/v1/prompt`
- 标签：`Prompt管理`
- 所有接口使用JWT认证依赖

**接口定义：**
- `POST /api/v1/prompt/create` - 创建Prompt
- `GET /api/v1/prompt/list` - 查询列表（支持分页和筛选）
- `PUT /api/v1/prompt/update` - 更新Prompt
- `DELETE /api/v1/prompt/delete` - 删除Prompt

**认证依赖：**
```python
from core.auth import AuthHandler
from dependencies import get_auth_handler

auth_handler: AuthHandler = get_auth_handler()
CurrentUserId = Annotated[int, Depends(auth_handler.auth_access_dependency)]
```

**路由装饰器：**
```python
@router.post("/create", response_model=APIResponse, summary="创建Prompt")
async def create_prompt(...):
    ...
```

### 7. 数据验证规范

**Schema验证：**
- Pydantic自动验证类型和必填字段
- 自定义验证器用于复杂验证逻辑
- 验证失败自动返回400错误

**业务验证：**
- name和content不能为空（在service层再次验证）
- platform值必须在["xiaohongshu", "douyin", "通用"]中
- page最小值为1，page_size最大值为100

### 8. 错误处理规范

**异常类型：**
- `HTTPException(status_code=400)`: 参数错误
- `HTTPException(status_code=401)`: 未授权（由认证中间件处理）
- `HTTPException(status_code=403)`: 无权限
- `HTTPException(status_code=404)`: 资源不存在
- `HTTPException(status_code=500)`: 服务器错误

**错误信息：**
- 开发环境返回详细错误信息
- 生产环境返回通用错误信息
- 使用`core.logger.logger`记录错误日志

## 代码示例

### 模型定义示例

```python
from models import Base
from sqlalchemy.orm import mapped_column, Mapped
from sqlalchemy import Integer, String, Text, DateTime, ForeignKey
from datetime import datetime

class Prompt(Base):
    """Prompt模板模型"""
    __tablename__ = 'prompt'
    
    id: Mapped[int] = mapped_column(Integer, primary_key=True, autoincrement=True)
    name: Mapped[str] = mapped_column(String(255), nullable=False)
    content: Mapped[str] = mapped_column(Text, nullable=False)
    platform: Mapped[str] = mapped_column(String(50), default="通用", nullable=False)
    category: Mapped[str | None] = mapped_column(String(100), nullable=True)
    description: Mapped[str | None] = mapped_column(String(500), nullable=True)
    user_id: Mapped[int] = mapped_column(Integer, ForeignKey("user.id"), nullable=False)
    created_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.now, nullable=False)
    updated_at: Mapped[datetime] = mapped_column(DateTime, default=datetime.now, onupdate=datetime.now, nullable=False)
```

### Service层示例

```python
from fastapi import HTTPException
from utils.response import APIResponse, success_response
from repository.prompt_repo import PromptRepository
from schemas.prompt import PromptCreateIn, PromptOut

class PromptService:
    def __init__(self, repo: PromptRepository):
        self.repo = repo
    
    async def create_prompt(self, user_id: int, data: PromptCreateIn) -> APIResponse:
        """创建Prompt"""
        # 验证数据
        if not data.name or not data.content:
            raise HTTPException(status_code=400, detail="name和content不能为空")
        
        # 创建Prompt
        prompt = await self.repo.create(user_id, data)
        
        # 返回响应
        return success_response(PromptOut.model_validate(prompt))
```

## 最佳实践

1. **权限校验优先**：所有涉及用户资源的操作，首先校验权限
2. **事务管理**：使用`async with session.begin()`确保数据一致性
3. **错误信息明确**：错误提示要具体，便于调试和定位问题
4. **日志记录**：关键操作（创建、更新、删除）记录日志
5. **代码复用**：权限校验逻辑提取为独立方法，避免重复

## 常见错误避免

1. ❌ **忘记权限校验**：所有操作必须校验user_id
2. ❌ **跨层调用**：Repository直接调用Service
3. ❌ **忽略事务**：数据库操作没有使用事务管理
4. ❌ **错误处理不当**：直接返回数据库异常，没有转换为HTTPException
5. ❌ **缺少日志**：关键操作没有记录日志
